# Projektarbeit - Automated reportbased CSP Generation
The aim of this project is a tool for automated Content-Security-Policy generation for a certain website based on reports generated by browsers and/or testing tools - independent from the used server. 
To achieve this our tools consists of 3 (or 4) components: 
 1. A reverse proxy for the site which is used in the generation process
 2. A cgi/fcgi component for report collection
 3. Programs for report processing and policy generation
 4. A reverse proxy for the site which is acting as the frontend for the webservice instead of the actual site and which is using the generated policy

## Proxies
There are already multiple reverse proxies/webservers which fulfill our needs (adding headers to outgoing responses), namely:
 1. nginx
 2. apache http server

Unluckily some dedicated proxies like tinyproxy do NOT have the needed functionalities but as we need basic webserver functionality for 2. anyway we focused on working with nginx for this project.

The according Docker containers and configurations can be found in the `proxygen` and `proxyprod` folders.

## Collection
CSP Reporting is simple POSTing of a JSON object for every violation to a URL specified in the policy. What needs to be done in collection is therefor 
 1. Taking in the violation reports
 2. Storing the reports / passing the reports to the generator

For this we use php-fpm in a Docker container which is being called by the Nginx instances

The needed php-scripts are (so far - as we only write to a file) very simple and can be found in the `collector` folder.

## Generation
In generation collected reports are processed and an minimal, according policy is created.

Unluckily violation reports generated by different browsers differ substancially, so having one processor for all types of clients would be difficult. It could be achieved by analysis of the reports or by storing the UAS of the reporter.

We instead choose to focus on violation reports generated by Google Chrome as reports generated by Chrome contain some useful information which is not sent by Firefo.

The generator can be found in the generator-folder.

## Installation
Please make sure you have all the dependencies installed:
 1. docker
 2. docker-compose
 3. ghc 
 4. cabal
   3. Aeson

Then run:
 2. Build: `make build`
 3. Install: `sudo ./install.sh`

## Usage
 1. Start the Docker containers: `csprg_start`
 3. Run your tests on your clients Google Chrome using `IP:8080` as the address of the webservice (where `IP` is the proxies address).
 4. Generate a policy using `sudo csprg_generate`. It will be written to `/usr/share/csprg/csprg_collector.csp` and applied automatically to `proxyprod`.

Before running future tests you might have to reset the `collector` container as otherwise old reports will be accumulating.

In the configuration file (`/etc/csprg/gen.conf`) you can add directives that will be automatically be added or never be added to the policy.
